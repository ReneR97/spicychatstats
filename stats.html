<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpicyChat Stats Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-card: #13131f;
            --bg-card-hover: #1a1a2e;
            --bg-glass: rgba(19, 19, 31, 0.7);
            --bg-input: #0e0e18;
            --border: rgba(255, 255, 255, 0.06);
            --border-glow: rgba(255, 107, 107, 0.2);
            --text-primary: #f0f0f5;
            --text-secondary: #8888a4;
            --text-muted: #55556a;
            --accent-1: #ff6b6b;
            --accent-2: #ee5a24;
            --accent-3: #f0932b;
            --accent-4: #6c5ce7;
            --accent-5: #a29bfe;
            --accent-6: #fd79a8;
            --gradient-fire: linear-gradient(135deg, #ff6b6b, #ee5a24);
            --gradient-sunset: linear-gradient(135deg, #f0932b, #ff6b6b);
            --gradient-purple: linear-gradient(135deg, #6c5ce7, #a29bfe);
            --gradient-pink: linear-gradient(135deg, #fd79a8, #e84393);
            --gradient-teal: linear-gradient(135deg, #00b894, #00cec9);
            --gradient-blue: linear-gradient(135deg, #0984e3, #74b9ff);
            --shadow-glow: 0 0 40px rgba(255, 107, 107, 0.08);
            --radius: 16px;
            --radius-sm: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 20%, rgba(255, 107, 107, 0.04) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(108, 92, 231, 0.04) 0%, transparent 50%);
            z-index: -1;
            animation: ambientPulse 15s ease-in-out infinite alternate;
        }

        @keyframes ambientPulse {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(10deg);
            }
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 40px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid var(--border);
            width: fit-content;
        }

        .tab-btn {
            padding: 12px 28px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 9px;
            transition: all 0.25s ease;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.03);
        }

        .tab-btn.active {
            background: var(--gradient-fire);
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: none;
            }
        }

        /* ===== HEADER ===== */
        .header {
            text-align: center;
            margin-bottom: 48px;
        }

        .header h1 {
            font-size: 3.2rem;
            font-weight: 900;
            letter-spacing: -1.5px;
            background: var(--gradient-fire);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .header .subtitle {
            font-size: 1.05rem;
            color: var(--text-secondary);
        }

        .header .subtitle span {
            color: var(--accent-1);
            font-weight: 600;
        }

        /* ===== STAT CARDS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 18px;
            margin-bottom: 48px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 26px 22px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, border-color 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--border-glow);
            box-shadow: var(--shadow-glow);
        }

        .stat-card .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 12px;
            display: block;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: -1px;
            line-height: 1;
            margin-bottom: 5px;
        }

        .stat-card .stat-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .stat-card:nth-child(1) .stat-value {
            color: #ff6b6b;
        }

        .stat-card:nth-child(1)::after {
            background: var(--gradient-fire);
        }

        .stat-card:nth-child(2) .stat-value {
            color: #f0932b;
        }

        .stat-card:nth-child(2)::after {
            background: var(--gradient-sunset);
        }

        .stat-card:nth-child(3) .stat-value {
            color: #6c5ce7;
        }

        .stat-card:nth-child(3)::after {
            background: var(--gradient-purple);
        }

        .stat-card:nth-child(4) .stat-value {
            color: #fd79a8;
        }

        .stat-card:nth-child(4)::after {
            background: var(--gradient-pink);
        }

        .stat-card:nth-child(5) .stat-value {
            color: #00b894;
        }

        .stat-card:nth-child(5)::after {
            background: var(--gradient-teal);
        }

        .stat-card:nth-child(6) .stat-value {
            color: #74b9ff;
        }

        .stat-card:nth-child(6)::after {
            background: var(--gradient-blue);
        }

        /* ===== SECTION TITLES ===== */
        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, var(--border), transparent);
        }

        /* ===== CHARTS ===== */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 22px;
            margin-bottom: 44px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 26px;
            transition: border-color 0.3s;
        }

        .chart-card:hover {
            border-color: var(--border-glow);
        }

        .chart-card h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 18px;
            color: var(--text-secondary);
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
        }

        .chart-container-tall {
            height: 360px;
        }

        /* ===== TAG BARS ===== */
        .tag-bars {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tag-bar-row {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .tag-bar-label {
            font-size: 0.82rem;
            font-weight: 500;
            min-width: 130px;
            text-align: right;
            color: var(--text-secondary);
        }

        .tag-bar-track {
            flex: 1;
            height: 26px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            overflow: hidden;
        }

        .tag-bar-fill {
            height: 100%;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-size: 0.72rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
            min-width: 36px;
        }

        /* ===== FUN FACTS ===== */
        .fun-facts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
            margin-bottom: 44px;
        }

        .fun-fact {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 18px 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .fun-fact .fact-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .fun-fact .fact-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .fun-fact .fact-text strong {
            color: var(--text-primary);
        }

        /* ===== TABLES ===== */
        .table-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 26px;
            margin-bottom: 44px;
            overflow-x: auto;
        }

        .table-card h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 18px;
            color: var(--text-secondary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            text-align: left;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
        }

        tbody td {
            padding: 12px 14px;
            font-size: 0.88rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            vertical-align: middle;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: rgba(255, 107, 107, 0.03);
        }

        .rank-badge {
            width: 26px;
            height: 26px;
            border-radius: 7px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.72rem;
            font-weight: 700;
        }

        .rank-1 {
            background: linear-gradient(135deg, #f0932b, #ff6b6b);
            color: #fff;
        }

        .rank-2 {
            background: linear-gradient(135deg, #b2bec3, #dfe6e9);
            color: #2d3436;
        }

        .rank-3 {
            background: linear-gradient(135deg, #e17055, #d35400);
            color: #fff;
        }

        .rank-default {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        .char-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .char-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
        }

        .char-name {
            font-weight: 600;
        }

        .char-title {
            font-size: 0.76rem;
            color: var(--text-muted);
            margin-top: 2px;
            max-width: 380px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .msg-count {
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .conv-count {
            font-variant-numeric: tabular-nums;
            color: var(--text-secondary);
        }

        .tag-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .tag-pill {
            font-size: 0.66rem;
            font-weight: 500;
            padding: 3px 7px;
            border-radius: 6px;
            background: rgba(255, 107, 107, 0.08);
            color: var(--accent-1);
            border: 1px solid rgba(255, 107, 107, 0.12);
        }

        /* ===== CONVERSATIONS BROWSER (Tab 2) ===== */
        .browser-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 24px;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 260px;
            padding: 12px 18px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.25s;
        }

        .search-box:focus {
            border-color: var(--accent-1);
        }

        .search-box::placeholder {
            color: var(--text-muted);
        }

        .filter-select {
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
            cursor: pointer;
            min-width: 160px;
            transition: border-color 0.25s;
        }

        .filter-select:focus {
            border-color: var(--accent-1);
        }

        .sort-btn {
            padding: 12px 18px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.82rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s;
            white-space: nowrap;
        }

        .sort-btn:hover {
            border-color: var(--accent-1);
            color: var(--text-primary);
        }

        .sort-btn.active {
            border-color: var(--accent-1);
            color: var(--accent-1);
        }

        .results-count {
            font-size: 0.82rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .conv-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Accordion card */
        .acc-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            transition: border-color 0.25s;
        }

        .acc-card:hover,
        .acc-card.open {
            border-color: var(--border-glow);
        }

        .acc-header {
            display: grid;
            grid-template-columns: 1fr 100px 80px 100px 42px;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }

        .acc-header:hover {
            background: var(--bg-card-hover);
        }

        .acc-toggle {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.04);
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: transform 0.3s, background 0.2s;
            flex-shrink: 0;
        }

        .acc-card.open .acc-toggle {
            transform: rotate(180deg);
            background: rgba(255, 107, 107, 0.12);
            color: var(--accent-1);
        }

        .conv-char-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conv-char-avatar {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
        }

        .conv-char-info {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .conv-char-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .conv-char-title {
            font-size: 0.74rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 420px;
        }

        .conv-msgs {
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            font-size: 0.88rem;
            text-align: center;
        }

        .conv-convos {
            font-variant-numeric: tabular-nums;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-align: center;
        }

        .conv-date {
            font-size: 0.78rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* Accordion body */
        .acc-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .acc-card.open .acc-body {
            max-height: 2000px;
        }

        .acc-inner {
            padding: 0 18px 16px;
            border-top: 1px solid var(--border);
        }

        .acc-inner-header {
            display: grid;
            grid-template-columns: 1fr 90px 110px 90px;
            gap: 10px;
            padding: 10px 0 6px;
            font-size: 0.68rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .acc-conv-row {
            display: grid;
            grid-template-columns: 1fr 90px 110px 90px;
            gap: 10px;
            align-items: center;
            padding: 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.03);
        }

        .acc-conv-row:first-of-type {
            border-top: none;
        }

        .acc-conv-id {
            font-size: 0.78rem;
            color: var(--text-secondary);
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .acc-conv-msgs {
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            font-variant-numeric: tabular-nums;
        }

        .acc-conv-date {
            font-size: 0.78rem;
            color: var(--text-muted);
            text-align: center;
        }

        .conv-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 7px;
            font-size: 0.74rem;
            font-weight: 600;
            text-decoration: none;
            background: var(--gradient-fire);
            color: #fff;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }

        .conv-link:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(255, 107, 107, 0.3);
        }

        .conv-link-sm {
            padding: 5px 10px;
            font-size: 0.7rem;
            background: rgba(255, 107, 107, 0.12);
            color: var(--accent-1);
            border: 1px solid rgba(255, 107, 107, 0.2);
        }

        .conv-link-sm:hover {
            background: var(--gradient-fire);
            color: #fff;
            border-color: transparent;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 28px;
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.82rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover {
            border-color: var(--accent-1);
            color: var(--text-primary);
        }

        .page-btn.active {
            background: var(--gradient-fire);
            color: #fff;
            border-color: transparent;
        }

        .page-btn:disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .page-info {
            font-size: 0.82rem;
            color: var(--text-muted);
            padding: 0 12px;
        }

        /* ===== LOADING ===== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            flex-direction: column;
            gap: 18px;
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 3px solid rgba(255, 107, 107, 0.15);
            border-top-color: var(--accent-1);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 900px) {
            .header h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .conv-row {
                grid-template-columns: 1fr 80px 80px;
            }

            .conv-date,
            .conv-convos {
                display: none;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px 12px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .stat-card {
                padding: 18px 14px;
            }

            .stat-card .stat-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container" id="app">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">Loading stats...</p>
        </div>
    </div>

    <script>
        (async function () {
            const res = await fetch('aggregated.json');
            const data = await res.json();

            // =========== CALCULATIONS ===========
            const totalCharacters = data.length;
            const totalConversations = data.reduce((s, c) => s + c.total_conversations, 0);
            const allMsgCounts = data.flatMap(c => c.message_counts);
            const totalMessages = allMsgCounts.reduce((s, n) => s + n, 0);

            const sorted = [...allMsgCounts].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            const median = sorted.length % 2 !== 0 ? sorted[mid] : Math.round((sorted[mid - 1] + sorted[mid]) / 2);
            const average = Math.round(totalMessages / allMsgCounts.length);
            const maxMsg = Math.max(...allMsgCounts);

            // Tags
            const tagMap = {};
            data.forEach(c => (c.tags || []).forEach(t => { tagMap[t] = (tagMap[t] || 0) + 1; }));
            const tagsSorted = Object.entries(tagMap).sort((a, b) => b[1] - a[1]);
            const top20Tags = tagsSorted.slice(0, 20);

            // Top characters by total messages
            const charsWithTotal = data.map(c => ({
                ...c,
                totalMessages: c.message_counts.reduce((s, n) => s + n, 0)
            })).sort((a, b) => b.totalMessages - a.totalMessages);
            const top25Chars = charsWithTotal.slice(0, 25);

            // Most revisited
            const charsByConvs = [...data].sort((a, b) => b.total_conversations - a.total_conversations);
            const topConvChars = charsByConvs.slice(0, 10);

            // Message distribution
            const buckets = [
                { label: '1-10', min: 1, max: 10, count: 0 },
                { label: '11-25', min: 11, max: 25, count: 0 },
                { label: '26-50', min: 26, max: 50, count: 0 },
                { label: '51-100', min: 51, max: 100, count: 0 },
                { label: '101-200', min: 101, max: 200, count: 0 },
                { label: '201-500', min: 201, max: 500, count: 0 },
                { label: '500+', min: 501, max: Infinity, count: 0 },
            ];
            allMsgCounts.forEach(n => { for (const b of buckets) { if (n >= b.min && n <= b.max) { b.count++; break; } } });

            // Convo per char distribution
            const convBuckets = [
                { label: '1', min: 1, max: 1, count: 0 },
                { label: '2-3', min: 2, max: 3, count: 0 },
                { label: '4-5', min: 4, max: 5, count: 0 },
                { label: '6-10', min: 6, max: 10, count: 0 },
                { label: '11+', min: 11, max: Infinity, count: 0 },
            ];
            data.forEach(c => { for (const b of convBuckets) { if (c.total_conversations >= b.min && c.total_conversations <= b.max) { b.count++; break; } } });

            const noTagsCount = data.filter(c => !c.tags || c.tags.length === 0).length;
            const mostChatted = charsWithTotal[0];
            const mostRevisited = charsByConvs[0];
            const singleMsg = allMsgCounts.filter(n => n <= 5).length;

            // =========== TIMELINE DATA ===========
            // Flatten all conversations with character info
            const allConvs = [];
            data.forEach(c => {
                (c.conversations || []).forEach(conv => {
                    allConvs.push({
                        convId: conv.id,
                        characterId: c.character_id,
                        name: c.name,
                        title: c.title,
                        avatar_url: c.avatar_url,
                        tags: c.tags || [],
                        messages: conv.message_count,
                        createdAt: conv.createdAt,
                        date: conv.createdAt ? new Date(conv.createdAt) : null,
                    });
                });
            });

            // Month-by-month
            const monthMap = {};
            const monthMsgMap = {};
            allConvs.forEach(c => {
                if (!c.date) return;
                const key = `${c.date.getFullYear()}-${String(c.date.getMonth() + 1).padStart(2, '0')}`;
                monthMap[key] = (monthMap[key] || 0) + 1;
                monthMsgMap[key] = (monthMsgMap[key] || 0) + c.messages;
            });
            const monthKeys = Object.keys(monthMap).sort();

            // Year-by-year
            const yearMap = {};
            const yearMsgMap = {};
            allConvs.forEach(c => {
                if (!c.date) return;
                const y = String(c.date.getFullYear());
                yearMap[y] = (yearMap[y] || 0) + 1;
                yearMsgMap[y] = (yearMsgMap[y] || 0) + c.messages;
            });
            const yearKeys = Object.keys(yearMap).sort();

            // Day of week distribution
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayMap = [0, 0, 0, 0, 0, 0, 0];
            allConvs.forEach(c => { if (c.date) dayMap[c.date.getDay()]++; });

            // Hour of day distribution
            const hourMap = new Array(24).fill(0);
            allConvs.forEach(c => { if (c.date) hourMap[c.date.getHours()]++; });

            // First and last conversation dates
            const datedConvs = allConvs.filter(c => c.date).sort((a, b) => a.date - b.date);
            const firstDate = datedConvs.length ? datedConvs[0].date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
            const lastDate = datedConvs.length ? datedConvs[datedConvs.length - 1].date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';

            // Busiest month
            let busiestMonth = monthKeys[0] || 'N/A';
            let busiestMonthCount = 0;
            monthKeys.forEach(k => { if (monthMap[k] > busiestMonthCount) { busiestMonthCount = monthMap[k]; busiestMonth = k; } });
            const busiestMonthLabel = busiestMonth !== 'N/A' ? formatMonth(busiestMonth) : 'N/A';

            function formatMonth(key) {
                const [y, m] = key.split('-');
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${months[parseInt(m) - 1]} ${y}`;
            }

            // =========== RENDER ===========
            document.getElementById('loading').style.display = 'none';
            const app = document.getElementById('app');

            app.innerHTML = `
            <div class="header">
                <h1>üå∂Ô∏è SpicyChat Stats</h1>
                <p class="subtitle">Your complete chat analytics ‚Äî <span>${totalCharacters.toLocaleString()} characters</span> explored</p>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="overview">üìä Overview</button>
                <button class="tab-btn" data-tab="timeline">üìÖ Timeline</button>
                <button class="tab-btn" data-tab="browser">üí¨ Conversations</button>
            </div>

            <!-- ===== TAB 1: OVERVIEW ===== -->
            <div class="tab-content active" id="tab-overview">
                <div class="stats-grid">
                    <div class="stat-card"><span class="stat-icon">üë§</span><div class="stat-value">${totalCharacters.toLocaleString()}</div><div class="stat-label">Characters</div></div>
                    <div class="stat-card"><span class="stat-icon">üí¨</span><div class="stat-value">${totalConversations.toLocaleString()}</div><div class="stat-label">Conversations</div></div>
                    <div class="stat-card"><span class="stat-icon">‚úâÔ∏è</span><div class="stat-value">${totalMessages.toLocaleString()}</div><div class="stat-label">Total Messages</div></div>
                    <div class="stat-card"><span class="stat-icon">üìä</span><div class="stat-value">${average}</div><div class="stat-label">Avg per Chat</div></div>
                    <div class="stat-card"><span class="stat-icon">üìà</span><div class="stat-value">${median}</div><div class="stat-label">Median per Chat</div></div>
                    <div class="stat-card"><span class="stat-icon">üî•</span><div class="stat-value">${maxMsg.toLocaleString()}</div><div class="stat-label">Longest Chat</div></div>
                </div>

                <div class="section-title">üìå Quick Insights</div>
                <div class="fun-facts">
                    <div class="fun-fact"><span class="fact-icon">üèÜ</span><div class="fact-text">Most chatted: <strong>${esc(mostChatted.name)}</strong> ‚Äî <strong>${mostChatted.totalMessages.toLocaleString()}</strong> messages</div></div>
                    <div class="fun-fact"><span class="fact-icon">üîÑ</span><div class="fact-text">Most revisited: <strong>${esc(mostRevisited.name)}</strong> ‚Äî <strong>${mostRevisited.total_conversations}</strong> convos</div></div>
                    <div class="fun-fact"><span class="fact-icon">üè∑Ô∏è</span><div class="fact-text">Top tag: <strong>${tagsSorted[0]?.[0] || 'N/A'}</strong> (${tagsSorted[0]?.[1] || 0} characters)</div></div>
                    <div class="fun-fact"><span class="fact-icon">üëª</span><div class="fact-text"><strong>${singleMsg}</strong> chats with ‚â§5 messages</div></div>
                    <div class="fun-fact"><span class="fact-icon">üìÖ</span><div class="fact-text">First chat: <strong>${firstDate}</strong></div></div>
                    <div class="fun-fact"><span class="fact-icon">üìÖ</span><div class="fact-text">Latest chat: <strong>${lastDate}</strong></div></div>
                </div>

                <div class="section-title">üìä Distributions</div>
                <div class="charts-row">
                    <div class="chart-card"><h3>Messages per Conversation</h3><div class="chart-container"><canvas id="msgHistogram"></canvas></div></div>
                    <div class="chart-card"><h3>Conversations per Character</h3><div class="chart-container"><canvas id="convHistogram"></canvas></div></div>
                </div>

                <div class="section-title">üè∑Ô∏è Top 20 Tags</div>
                <div class="chart-card" style="margin-bottom: 44px;"><div class="tag-bars" id="tagBars"></div></div>

                <div class="section-title">üèÜ Top 25 Characters by Messages</div>
                <div class="table-card">
                    <table><thead><tr><th>#</th><th>Character</th><th>Total Msgs</th><th>Convos</th><th>Avg</th><th>Tags</th></tr></thead>
                    <tbody id="topCharsBody"></tbody></table>
                </div>

                <div class="section-title">üîÑ Top 10 Most Revisited</div>
                <div class="table-card">
                    <table><thead><tr><th>#</th><th>Character</th><th>Convos</th><th>Message Counts</th><th>Total</th></tr></thead>
                    <tbody id="topRevisitedBody"></tbody></table>
                </div>
            </div>

            <!-- ===== TAB 2: TIMELINE ===== -->
            <div class="tab-content" id="tab-timeline">
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                    <div class="stat-card"><span class="stat-icon">üìÖ</span><div class="stat-value">${firstDate}</div><div class="stat-label" style="font-size: 0.65rem;">First Conversation</div></div>
                    <div class="stat-card"><span class="stat-icon">üî•</span><div class="stat-value">${busiestMonthLabel}</div><div class="stat-label" style="font-size: 0.65rem;">Busiest Month (${busiestMonthCount} convos)</div></div>
                    <div class="stat-card"><span class="stat-icon">üìÜ</span><div class="stat-value">${monthKeys.length}</div><div class="stat-label">Active Months</div></div>
                </div>

                <div class="section-title">üìÖ Conversations per Month</div>
                <div class="chart-card" style="margin-bottom: 44px;"><div class="chart-container chart-container-tall"><canvas id="monthlyConvs"></canvas></div></div>

                <div class="section-title">‚úâÔ∏è Messages per Month</div>
                <div class="chart-card" style="margin-bottom: 44px;"><div class="chart-container chart-container-tall"><canvas id="monthlyMsgs"></canvas></div></div>

                <div class="section-title">üìä Year Overview</div>
                <div class="charts-row">
                    <div class="chart-card"><h3>Conversations per Year</h3><div class="chart-container"><canvas id="yearlyConvs"></canvas></div></div>
                    <div class="chart-card"><h3>Messages per Year</h3><div class="chart-container"><canvas id="yearlyMsgs"></canvas></div></div>
                </div>

                <div class="section-title">‚è∞ Activity Patterns</div>
                <div class="charts-row">
                    <div class="chart-card"><h3>Conversations by Day of Week</h3><div class="chart-container"><canvas id="dayOfWeek"></canvas></div></div>
                    <div class="chart-card"><h3>Conversations by Hour of Day</h3><div class="chart-container"><canvas id="hourOfDay"></canvas></div></div>
                </div>
            </div>

            <!-- ===== TAB 3: CONVERSATIONS BROWSER ===== -->
            <div class="tab-content" id="tab-browser">
                <div class="browser-controls">
                    <input type="text" class="search-box" id="searchInput" placeholder="üîç  Search by character name or title...">
                    <select class="filter-select" id="tagFilter">
                        <option value="">All Tags</option>
                        ${tagsSorted.map(([t]) => `<option value="${esc(t)}">${esc(t)}</option>`).join('')}
                    </select>
                    <select class="filter-select" id="msgFilter">
                        <option value="">All Message Counts</option>
                        <option value="1-10">1-10 msgs</option>
                        <option value="11-50">11-50 msgs</option>
                        <option value="51-100">51-100 msgs</option>
                        <option value="101-200">101-200 msgs</option>
                        <option value="201+">201+ msgs</option>
                    </select>
                    <button class="sort-btn active" id="sortDate" data-sort="date">‚Üï Date</button>
                    <button class="sort-btn" id="sortMsgs" data-sort="msgs">‚Üï Messages</button>
                    <button class="sort-btn" id="sortName" data-sort="name">‚Üï Name</button>
                </div>
                <div class="results-count" id="resultsCount"></div>

                <div class="conv-list" id="convList"></div>
                <div class="pagination" id="pagination"></div>
            </div>
        `;

            // =========== TABS ===========
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
                });
            });

            // =========== CHART DEFAULTS ===========
            const chartDefs = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
            };
            const gridDark = { color: 'rgba(255,255,255,0.04)' };
            const ticksStyle = { color: '#8888a4', font: { size: 11 } };
            const barColors = ['rgba(255,107,107,0.7)', 'rgba(238,90,36,0.7)', 'rgba(240,147,43,0.7)', 'rgba(108,92,231,0.7)', 'rgba(162,155,254,0.7)', 'rgba(253,121,168,0.7)', 'rgba(0,184,148,0.7)'];

            // === Overview Charts ===
            new Chart(document.getElementById('msgHistogram'), {
                type: 'bar', data: { labels: buckets.map(b => b.label), datasets: [{ data: buckets.map(b => b.count), backgroundColor: barColors, borderRadius: 6, borderSkipped: false }] },
                options: { ...chartDefs, scales: { x: { grid: { display: false }, ticks: ticksStyle, border: { display: false } }, y: { grid: gridDark, ticks: ticksStyle, border: { display: false } } } }
            });
            new Chart(document.getElementById('convHistogram'), {
                type: 'bar', data: { labels: convBuckets.map(b => b.label), datasets: [{ data: convBuckets.map(b => b.count), backgroundColor: barColors.slice(3), borderRadius: 6, borderSkipped: false }] },
                options: { ...chartDefs, scales: { x: { grid: { display: false }, ticks: ticksStyle, border: { display: false } }, y: { grid: gridDark, ticks: ticksStyle, border: { display: false } } } }
            });

            // === Timeline Charts ===
            // Monthly conversations
            new Chart(document.getElementById('monthlyConvs'), {
                type: 'bar', data: {
                    labels: monthKeys.map(formatMonth),
                    datasets: [{ data: monthKeys.map(k => monthMap[k]), backgroundColor: 'rgba(255,107,107,0.6)', hoverBackgroundColor: 'rgba(255,107,107,0.85)', borderRadius: 4, borderSkipped: false }]
                },
                options: { ...chartDefs, scales: { x: { grid: { display: false }, ticks: { ...ticksStyle, maxRotation: 60, font: { size: 10 } }, border: { display: false } }, y: { grid: gridDark, ticks: ticksStyle, border: { display: false } } } }
            });
            // Monthly messages
            new Chart(document.getElementById('monthlyMsgs'), {
                type: 'line', data: {
                    labels: monthKeys.map(formatMonth),
                    datasets: [{
                        data: monthKeys.map(k => monthMsgMap[k]),
                        borderColor: '#6c5ce7', backgroundColor: 'rgba(108,92,231,0.1)',
                        fill: true, tension: 0.35, pointRadius: 3, pointHoverRadius: 6, pointBackgroundColor: '#6c5ce7',
                        borderWidth: 2,
                    }]
                },
                options: { ...chartDefs, scales: { x: { grid: { display: false }, ticks: { ...ticksStyle, maxRotation: 60, font: { size: 10 } }, border: { display: false } }, y: { grid: gridDark, ticks: ticksStyle, border: { display: false } } } }
            });
            // Yearly conversations
            new Chart(document.getElementById('yearlyConvs'), {
                type: 'bar', data: {
                    labels: yearKeys, datasets: [{ data: yearKeys.map(k => yearMap[k]), backgroundColor: 'rgba(240,147,43,0.65)', borderRadius: 6, borderSkipped: false }]
                },
                options: { ...chartDefs, scales: { x: { grid: { display: false }, ticks: ticksStyle, border: { display: false } }, y: { grid: gridDark, ticks: ticksStyle, border: { display: false } } } }
            });
            // Yearly messages
            new Chart(document.getElementById('yearlyMsgs'), {
                type: 'bar', data: {
                    labels: yearKeys, datasets: [{ data: yearKeys.map(k => yearMsgMap[k]), backgroundColor: 'rgba(0,184,148,0.65)', borderRadius: 6, borderSkipped: false }]
                },
                options: { ...chartDefs, scales: { x: { grid: { display: false }, ticks: ticksStyle, border: { display: false } }, y: { grid: gridDark, ticks: ticksStyle, border: { display: false } } } }
            });
            // Day of week
            new Chart(document.getElementById('dayOfWeek'), {
                type: 'bar', data: {
                    labels: dayNames, datasets: [{ data: dayMap, backgroundColor: 'rgba(253,121,168,0.6)', borderRadius: 6, borderSkipped: false }]
                },
                options: { ...chartDefs, scales: { x: { grid: { display: false }, ticks: ticksStyle, border: { display: false } }, y: { grid: gridDark, ticks: ticksStyle, border: { display: false } } } }
            });
            // Hour of day
            new Chart(document.getElementById('hourOfDay'), {
                type: 'bar', data: {
                    labels: Array.from({ length: 24 }, (_, i) => `${String(i).padStart(2, '0')}:00`),
                    datasets: [{ data: hourMap, backgroundColor: 'rgba(162,155,254,0.6)', borderRadius: 3, borderSkipped: false }]
                },
                options: { ...chartDefs, scales: { x: { grid: { display: false }, ticks: { ...ticksStyle, maxRotation: 60, font: { size: 9 } }, border: { display: false } }, y: { grid: gridDark, ticks: ticksStyle, border: { display: false } } } }
            });

            // =========== TAG BARS ===========
            const tagBarsEl = document.getElementById('tagBars');
            const maxTagCount = top20Tags[0]?.[1] || 1;
            const grads = ['linear-gradient(90deg,#ff6b6b,#ee5a24)', 'linear-gradient(90deg,#f0932b,#ff6b6b)', 'linear-gradient(90deg,#6c5ce7,#a29bfe)', 'linear-gradient(90deg,#fd79a8,#e84393)', 'linear-gradient(90deg,#00b894,#00cec9)', 'linear-gradient(90deg,#0984e3,#74b9ff)'];
            top20Tags.forEach(([tag, count], i) => {
                const pct = (count / maxTagCount * 100).toFixed(1);
                const row = document.createElement('div'); row.className = 'tag-bar-row';
                row.innerHTML = `<span class="tag-bar-label">${esc(tag)}</span><div class="tag-bar-track"><div class="tag-bar-fill" style="width:${pct}%;background:${grads[i % grads.length]};">${count}</div></div>`;
                tagBarsEl.appendChild(row);
            });

            // =========== AVATAR HELPER ===========
            function avatarSrc(path, size) {
                if (!path) return '';
                return `https://cdn.nd-api.com/${path}?class=${size || 'avatar400x400'}`;
            }

            // =========== TOP CHARS TABLE ===========
            const topBody = document.getElementById('topCharsBody');
            top25Chars.forEach((c, i) => {
                const rank = i + 1;
                const rc = rank <= 3 ? `rank-${rank}` : 'rank-default';
                const avg = c.total_conversations > 0 ? Math.round(c.totalMessages / c.total_conversations) : 0;
                const tags = (c.tags || []).slice(0, 4).map(t => `<span class="tag-pill">${esc(t)}</span>`).join('');
                const av = c.avatar_url ? `<img class="char-avatar" src="${avatarSrc(c.avatar_url)}" alt="" loading="lazy">` : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><span class="rank-badge ${rc}">${rank}</span></td><td><div class="char-cell">${av}<div><div class="char-name">${esc(c.name)}</div><div class="char-title">${esc(c.title)}</div></div></div></td><td class="msg-count">${c.totalMessages.toLocaleString()}</td><td class="conv-count">${c.total_conversations}</td><td class="conv-count">${avg}</td><td><div class="tag-pills">${tags}</div></td>`;
                topBody.appendChild(tr);
            });

            // =========== REVISITED TABLE ===========
            const revBody = document.getElementById('topRevisitedBody');
            topConvChars.forEach((c, i) => {
                const rank = i + 1;
                const rc = rank <= 3 ? `rank-${rank}` : 'rank-default';
                const total = c.message_counts.reduce((s, n) => s + n, 0);
                const av = c.avatar_url ? `<img class="char-avatar" src="${avatarSrc(c.avatar_url)}" alt="" loading="lazy">` : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><span class="rank-badge ${rc}">${rank}</span></td><td><div class="char-cell">${av}<div><div class="char-name">${esc(c.name)}</div><div class="char-title">${esc(c.title)}</div></div></div></td><td class="conv-count" style="font-weight:700;color:var(--text-primary);">${c.total_conversations}</td><td style="font-size:0.78rem;color:var(--text-muted);max-width:250px;word-break:break-all;">${c.message_counts.join(', ')}</td><td class="msg-count">${total.toLocaleString()}</td>`;
                revBody.appendChild(tr);
            });

            // =========== CONVERSATIONS BROWSER ===========
            // Build per-character data with all conversations
            const browserData = charsWithTotal.map(c => {
                const convs = (c.conversations || []).slice().sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
                const latestDate = convs.length && convs[0].createdAt ? convs[0].createdAt : null;
                return {
                    characterId: c.character_id,
                    name: c.name,
                    title: c.title,
                    avatar_url: c.avatar_url,
                    tags: c.tags || [],
                    totalMessages: c.totalMessages,
                    totalConversations: c.total_conversations,
                    latestDate,
                    convs, // all individual conversations
                };
            });

            let filteredData = [...browserData];
            let currentSort = 'date';
            let sortAsc = false;
            const PER_PAGE = 25;
            let currentPage = 1;
            const openAccordions = new Set();

            function applyFilters() {
                const search = document.getElementById('searchInput').value.toLowerCase().trim();
                const tagF = document.getElementById('tagFilter').value;
                const msgF = document.getElementById('msgFilter').value;

                filteredData = browserData.filter(c => {
                    if (search && !c.name.toLowerCase().includes(search) && !c.title.toLowerCase().includes(search)) return false;
                    if (tagF && !c.tags.includes(tagF)) return false;
                    if (msgF) {
                        const m = c.totalMessages;
                        if (msgF === '1-10' && (m < 1 || m > 10)) return false;
                        if (msgF === '11-50' && (m < 11 || m > 50)) return false;
                        if (msgF === '51-100' && (m < 51 || m > 100)) return false;
                        if (msgF === '101-200' && (m < 101 || m > 200)) return false;
                        if (msgF === '201+' && m < 201) return false;
                    }
                    return true;
                });

                applySort();
                currentPage = 1;
                renderBrowser();
            }

            function applySort() {
                filteredData.sort((a, b) => {
                    let cmp = 0;
                    if (currentSort === 'date') cmp = (a.latestDate || '').localeCompare(b.latestDate || '');
                    else if (currentSort === 'msgs') cmp = a.totalMessages - b.totalMessages;
                    else if (currentSort === 'name') cmp = a.name.localeCompare(b.name);
                    return sortAsc ? cmp : -cmp;
                });
            }

            function fmtDate(d) {
                if (!d) return '‚Äî';
                return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
            }
            function fmtDateLong(d) {
                if (!d) return '‚Äî';
                return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            }

            function renderBrowser() {
                const list = document.getElementById('convList');
                const pag = document.getElementById('pagination');
                const totalPages = Math.max(1, Math.ceil(filteredData.length / PER_PAGE));
                if (currentPage > totalPages) currentPage = totalPages;
                const start = (currentPage - 1) * PER_PAGE;
                const pageData = filteredData.slice(start, start + PER_PAGE);

                document.getElementById('resultsCount').textContent = `Showing ${start + 1}-${Math.min(start + PER_PAGE, filteredData.length)} of ${filteredData.length} characters`;

                list.innerHTML = pageData.map(c => {
                    const isOpen = openAccordions.has(c.characterId);
                    const innerRows = c.convs.map((cv, idx) => {
                        const chatUrl = `https://spicychat.ai/chat/${c.characterId}/${cv.id}`;
                        return `
                            <div class="acc-conv-row">
                                <div class="acc-conv-id" title="${cv.id}">Conversation ${idx + 1}</div>
                                <div class="acc-conv-msgs">${(cv.message_count || 0).toLocaleString()}</div>
                                <div class="acc-conv-date">${fmtDateLong(cv.createdAt)}</div>
                                <div style="text-align:center;"><a class="conv-link conv-link-sm" href="${chatUrl}" target="_blank" rel="noopener">Open ‚Üó</a></div>
                            </div>`;
                    }).join('');

                    return `
                    <div class="acc-card ${isOpen ? 'open' : ''}" data-cid="${c.characterId}">
                        <div class="acc-header">
                            <div class="conv-char-cell">
                                ${c.avatar_url ? `<img class="conv-char-avatar" src="${avatarSrc(c.avatar_url)}" alt="" loading="lazy">` : ''}
                                <div class="conv-char-info">
                                    <div class="conv-char-name">${esc(c.name)}</div>
                                    <div class="conv-char-title">${esc(c.title)}</div>
                                </div>
                            </div>
                            <div class="conv-msgs">${c.totalMessages.toLocaleString()} msgs</div>
                            <div class="conv-convos">${c.totalConversations} chats</div>
                            <div class="conv-date">${fmtDate(c.latestDate)}</div>
                            <div class="acc-toggle">‚ñº</div>
                        </div>
                        <div class="acc-body">
                            <div class="acc-inner">
                                <div class="acc-inner-header">
                                    <div>Conversation</div>
                                    <div style="text-align:center;">Messages</div>
                                    <div style="text-align:center;">Created</div>
                                    <div style="text-align:center;">Action</div>
                                </div>
                                ${innerRows}
                            </div>
                        </div>
                    </div>`;
                }).join('');

                // Accordion toggle handlers
                list.querySelectorAll('.acc-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        if (e.target.closest('a')) return; // don't toggle if clicking a link
                        const card = header.closest('.acc-card');
                        const cid = card.dataset.cid;
                        card.classList.toggle('open');
                        if (card.classList.contains('open')) {
                            openAccordions.add(cid);
                        } else {
                            openAccordions.delete(cid);
                        }
                    });
                });

                // Pagination
                let pagHtml = `<button class="page-btn" ${currentPage <= 1 ? 'disabled' : ''} data-page="${currentPage - 1}">‚Äπ Prev</button>`;
                const maxPages = 7;
                let startP = Math.max(1, currentPage - 3);
                let endP = Math.min(totalPages, startP + maxPages - 1);
                if (endP - startP < maxPages - 1) startP = Math.max(1, endP - maxPages + 1);
                for (let p = startP; p <= endP; p++) {
                    pagHtml += `<button class="page-btn ${p === currentPage ? 'active' : ''}" data-page="${p}">${p}</button>`;
                }
                pagHtml += `<button class="page-btn" ${currentPage >= totalPages ? 'disabled' : ''} data-page="${currentPage + 1}">Next ‚Ä∫</button>`;
                pagHtml += `<span class="page-info">${currentPage} / ${totalPages}</span>`;
                pag.innerHTML = pagHtml;

                pag.querySelectorAll('.page-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        currentPage = parseInt(btn.dataset.page);
                        renderBrowser();
                        document.getElementById('tab-browser').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    });
                });
            }

            // Event listeners
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('tagFilter').addEventListener('change', applyFilters);
            document.getElementById('msgFilter').addEventListener('change', applyFilters);

            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const newSort = btn.dataset.sort;
                    if (currentSort === newSort) {
                        sortAsc = !sortAsc;
                    } else {
                        currentSort = newSort;
                        sortAsc = false;
                    }
                    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    applySort();
                    currentPage = 1;
                    renderBrowser();
                });
            });

            // Initial render
            applyFilters();

            // =========== HELPERS ===========
            function esc(str) {
                const d = document.createElement('div'); d.textContent = str || ''; return d.innerHTML;
            }
        })();
    </script>
</body>

</html>